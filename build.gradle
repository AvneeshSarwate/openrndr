import org.gradle.nativeplatform.platform.internal.DefaultNativePlatform

buildscript {
    repositories {
        mavenCentral()
    }
    dependencies {
        classpath "org.jetbrains.dokka:dokka-gradle-plugin:0.10.1"
        classpath "com.netflix.nebula:nebula-release-plugin:15.3.1"
    }
}

plugins {
    // remember to update all the versions here when upgrading kotlin version
    id 'org.jetbrains.kotlin.jvm' version '1.5.10' apply false
    id 'org.jetbrains.kotlin.multiplatform' version '1.5.10' apply false
    id 'org.jetbrains.kotlin.plugin.serialization' version '1.5.10' apply false
}

apply plugin: 'org.jetbrains.dokka'

/*
  Note: check out the latest Kotlin release docs to keep all in sync:

  https://kotlinlang.org/docs/releases.html#release-details

  Warning: coroutines and logging cannot be parametrized with project.ext
  see below!
*/
project.ext {
    kotlinApiVersion = '1.4'
    kotlinLanguageVersion = '1.4'
    kotlinVersion = '1.5.10'
    kotlinLoggingVersion = '2.0.6'
    kotlinxSerializationVersion = '1.1.0'
    lwjglVersion = '3.2.3'
    javacpp_version = '1.5.4'
    ffmpeg_version = "4.3.1-$javacpp_version"
    spekVersion = '2.0.15'
    kluentVersion = '1.65'
    jsoupVersion = '1.13.1'
    kotestVersion = '4.4.3'
    junitJupiterVersion = '5.7.1'
}

dokka {
//
    outputDirectory = "$buildDir/docs"
    outputFormat = "html"
//    includes = ['Module.md']


    configuration {
        moduleName = "$rootProject.name"
        platform = "JVM"
        skipDeprecated = true
        includeNonPublic = false

        disableAutoconfiguration = false

        subProjects = ["openrndr-animatable", "openrndr-color", "openrndr-core", "openrndr-dialogs", "openrndr-event",
                       "openrndr-extensions", "openrndr-filter", "openrndr-math", "openrndr-shape", "openrndr-svg"]

        sourceLink {
            url = "https://github.com/openrndr/openrndr/blob/master/openrndr-core/src/main/kotlin"
            lineSuffix = "#L"
        }
        perPackageOption {
            prefix = "org.openrndr.internal"
            suppress = true
        }
        perPackageOption {
            prefix = "org.openrndr.shape.tessellation"
            suppress = true
        }
    }

    if (!System.properties['os.name'].toLowerCase().contains('windows')) {
        doLast {
            exec {
                executable "./dokka/postbuild.sh"
            }
        }
    }
}

allprojects {
    group 'org.openrndr'
    repositories {
        mavenCentral()
    }
}

def multiplatformModules = [
        "openrndr-application",
        "openrndr-event",
        "openrndr-math",
        "openrndr-color",
        "openrndr-utils",
        "openrndr-shape",
        "openrndr-binpack",
        "openrndr-animatable",
        "openrndr-draw",
        "openrndr-webgl",
        "openrndr-extensions",
        "openrndr-dds",
        "openrndr-openal",
        "openrndr-openal-natives-linux-arm64",
        "openrndr-openal-natives-linux-x64",
        "openrndr-openal-natives-macos",
        "openrndr-openal-natives-windows",
        "openrndr-gl3",
        "openrndr-gl3-natives-linux-arm64",
        "openrndr-gl3-natives-linux-x64",
        "openrndr-gl3-natives-macos",
        "openrndr-gl3-natives-windows",
        "openrndr-tessellation",
        "openrndr-svg"


]


configure(allprojects.findAll { !multiplatformModules.contains(it.name) }) {
    apply plugin: 'idea'
    apply plugin: 'java'
    apply plugin: 'kotlin'


    dependencies {
        // Note: kotlin-logging and kotlinx-coroutines-core are loaded
        // too early and their versions cannot be parametrized
        implementation 'io.github.microutils:kotlin-logging:2.0.6'
        implementation 'org.jetbrains.kotlinx:kotlinx-coroutines-core:1.4.3'

        implementation "org.jetbrains.kotlin:kotlin-stdlib:$kotlinVersion"

        testImplementation "org.spekframework.spek2:spek-dsl-jvm:$spekVersion"
        testImplementation "org.amshove.kluent:kluent:$kluentVersion"
        testImplementation "org.jetbrains.kotlin:kotlin-test:$kotlinVersion"
        testRuntimeOnly "org.spekframework.spek2:spek-runner-junit5:$spekVersion"
        testRuntimeOnly "org.jetbrains.kotlin:kotlin-reflect:$kotlinVersion"
    }

    test {
        useJUnitPlatform {
            includeEngines 'spek2'
        }
    }

    java {
        sourceCompatibility = JavaVersion.VERSION_1_8
        targetCompatibility = JavaVersion.VERSION_1_8
    }

    javadoc {
        options.addBooleanOption 'Xdoclint:none', true
    }

    tasks.withType(org.jetbrains.kotlin.gradle.tasks.AbstractKotlinCompile).all {
        kotlinOptions.freeCompilerArgs += ["-Xuse-experimental=kotlinx.coroutines.InternalCoroutinesApi"]
    }


}

configure(allprojects.findAll { it.name != "openrndr-demos" }) {

    apply plugin: 'maven-publish'

    apply plugin: 'nebula.release'


}
